name: Update Dataset Configuration

on:
  push:
    branches: [main]
    paths:
      - 'datasets/dataset-url.txt'
      - '.github/workflows/update-dataset-config.yml'

permissions:
  contents: write

jobs:
  update-dataset-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Read dataset URL from file
        id: dataset
        run: |
          DATASET_URL=$(cat datasets/dataset-url.txt | grep -v '^#' | grep -v '^$' | head -n1)
          echo "DATASET_URL=$DATASET_URL" >> $GITHUB_OUTPUT
          echo "Dataset URL from file: $DATASET_URL"

      - name: Get current ConfigMap values
        id: current
        run: |
          CURRENT_URL=$(grep 'dataset.url:' k8s/configmap-dataset.yaml | sed 's/.*dataset.url: "\(.*\)"/\1/')
          CURRENT_VERSION=$(grep 'dataset.version:' k8s/configmap-dataset.yaml | sed 's/.*dataset.version: "\(.*\)"/\1/')
          
          echo "CURRENT_URL=$CURRENT_URL" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current URL: $CURRENT_URL"
          echo "Current version: $CURRENT_VERSION"

      - name: Check if URL changed
        id: check_change
        run: |
          if [ "${{ steps.dataset.outputs.DATASET_URL }}" == "${{ steps.current.outputs.CURRENT_URL }}" ]; then
            echo "URL_CHANGED=false" >> $GITHUB_OUTPUT
            echo "Dataset URL unchanged - no update needed"
          else
            echo "URL_CHANGED=true" >> $GITHUB_OUTPUT
            echo "Dataset URL changed - will increment version"
          fi

      - name: Calculate new version
        if: steps.check_change.outputs.URL_CHANGED == 'true'
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.CURRENT_VERSION }}"
          
          if [[ $CURRENT_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          else
            NEW_VERSION="1.0.0"
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version increment: $CURRENT_VERSION -> $NEW_VERSION"

      - name: Pull latest changes before updating
        if: steps.check_change.outputs.URL_CHANGED == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git pull --rebase origin main || echo "Already up to date"

      - name: Update ConfigMap
        if: steps.check_change.outputs.URL_CHANGED == 'true'
        run: |
          sed -i "s|dataset.url: \".*\"|dataset.url: \"${{ steps.dataset.outputs.DATASET_URL }}\"|g" k8s/configmap-dataset.yaml
          sed -i "s|dataset.version: \".*\"|dataset.version: \"${{ steps.new_version.outputs.NEW_VERSION }}\"|g" k8s/configmap-dataset.yaml
          
          echo "Updated ConfigMap:"
          grep -E 'dataset\.(url|version):' k8s/configmap-dataset.yaml

      - name: Commit and push ConfigMap changes
        if: steps.check_change.outputs.URL_CHANGED == 'true'
        run: |
          git add k8s/configmap-dataset.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update dataset configuration to v${{ steps.new_version.outputs.NEW_VERSION }}
            
            Dataset URL changed:
            - Old: ${{ steps.current.outputs.CURRENT_URL }}
            - New: ${{ steps.dataset.outputs.DATASET_URL }}
            
            Version: ${{ steps.current.outputs.CURRENT_VERSION }} -> ${{ steps.new_version.outputs.NEW_VERSION }}
            
            This will trigger ArgoCD sync and automatic model retraining."
            
            git push
            echo "ConfigMap updated and pushed to Git"
          fi

      - name: Workflow summary
        run: |
          echo "Dataset Configuration Update"
          echo "============================"
          if [ "${{ steps.check_change.outputs.URL_CHANGED }}" == "true" ]; then
            echo "Status: UPDATED"
            echo "Old URL: ${{ steps.current.outputs.CURRENT_URL }}"
            echo "New URL: ${{ steps.dataset.outputs.DATASET_URL }}"
            echo "Old Version: ${{ steps.current.outputs.CURRENT_VERSION }}"
            echo "New Version: ${{ steps.new_version.outputs.NEW_VERSION }}"
            echo ""
            echo "Next Steps:"
            echo "1. ArgoCD will detect ConfigMap change in Git"
            echo "2. ArgoCD will sync ConfigMap to Kubernetes cluster"
            echo "3. Training pod will detect version change"
            echo "4. Training pod will automatically retrain model"
          else
            echo "Status: NO CHANGE"
            echo "Dataset URL unchanged - no action taken"
          fi