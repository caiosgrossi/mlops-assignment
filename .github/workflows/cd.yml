name: CD - Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub (Optional)
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true
    
    - name: Build and push ML Service
      uses: docker/build-push-action@v5
      with:
        context: ./services/ml-service
        push: ${{ github.event_name != 'pull_request' && secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/ml-service:latest
          ${{ secrets.DOCKER_USERNAME }}/ml-service:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      continue-on-error: true
    
    - name: Build and push Backend API
      uses: docker/build-push-action@v5
      with:
        context: ./services/backend-api
        push: ${{ github.event_name != 'pull_request' && secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/backend-api:latest
          ${{ secrets.DOCKER_USERNAME }}/backend-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      continue-on-error: true
    
    - name: Build and push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./services/frontend
        push: ${{ github.event_name != 'pull_request' && secrets.DOCKER_USERNAME != '' }}
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/frontend:latest
          ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      continue-on-error: true
  
  deploy-info:
    name: Deployment Information
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Display ArgoCD Instructions
      run: |
        echo "========================================="
        echo "ArgoCD Deployment Instructions"
        echo "========================================="
        echo ""
        echo "To deploy using ArgoCD, apply the application manifest:"
        echo "kubectl apply -f k8s/.argocd/application.yaml"
        echo ""
        echo "Or use ArgoCD CLI:"
        echo "argocd app create playlist-recommender \\"
        echo "  --repo https://github.com/${{ github.repository }}.git \\"
        echo "  --path k8s \\"
        echo "  --dest-server https://kubernetes.default.svc \\"
        echo "  --dest-namespace playlist-recommender"
        echo ""
        echo "Enable auto-sync:"
        echo "argocd app set playlist-recommender --sync-policy automated"
        echo ""
        echo "Manual sync:"
        echo "argocd app sync playlist-recommender"
        echo ""
        echo "========================================="
